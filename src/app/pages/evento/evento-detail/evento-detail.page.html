<ng-container *ngIf="evento; else loading">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/home/evento-list"></ion-back-button>
      </ion-buttons>
      <ion-title>
        {{ isEditMode ? 'Editando: ' + evento.codigo : evento.codigo + ' - ' +
        evento.titulo }}
      </ion-title>

      <ion-buttons slot="primary">
        <ion-button (click)="presentActionSheet()" *ngIf="!isEditMode">
          <ion-icon
            slot="icon-only"
            name="ellipsis-vertical-circle-outline"
          ></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <ion-content>
    <form [formGroup]="eventoForm" (ngSubmit)="onSubmit()">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Informações Principais</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-label position="floating">Código *</ion-label>
            <ion-input
              formControlName="codigo"
              type="text"
              [readonly]="true"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Título *</ion-label>
            <ion-input
              formControlName="titulo"
              type="text"
              [readonly]="!isEditMode"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Descrição</ion-label>
            <ion-textarea
              formControlName="descricao"
              [readonly]="!isEditMode"
              [autoGrow]="true"
            ></ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Endereço</ion-label>
            <ion-input
              formControlName="endereco"
              type="text"
              [readonly]="!isEditMode"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label>Status *</ion-label>
            <ion-select
              formControlName="status"
              interface="popover"
              [disabled]="!isEditMode"
            >
              <ion-select-option value="Pendente">Pendente</ion-select-option>
              <ion-select-option value="EmAnalise"
                >Em Análise</ion-select-option
              >
              <ion-select-option value="EmAtendimento"
                >Em Atendimento</ion-select-option
              >
              <ion-select-option value="EmMonitoramento"
                >Em Monitoramento</ion-select-option
              >
              <ion-select-option value="Finalizado"
                >Finalizado</ion-select-option
              >
              <ion-select-option value="Cancelado">Cancelado</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Data e Hora *</ion-label>
            <ion-datetime-button
              datetime="datetime"
              [disabled]="!isEditMode"
            ></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="datetime"
                  formControlName="dataEHoraDoEvento"
                  presentation="date-time"
                  locale="pt-BR"
                ></ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>

          <ion-item lines="none">
            <p>
              <strong>Criado por:</strong> {{ evento.usuarioCriador.nome }} ({{
              evento.usuarioCriador.email }})
            </p>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="isEditMode">
        <ion-card-header>
          <ion-card-title>Relações</ion-card-title>
        </ion-card-header>
        <ion-list>
          <ion-item>
            <ion-label>Evento Pai</ion-label>
            <ion-select
              formControlName="eventoPaiId"
              placeholder="Nenhum"
              interface="popover"
            >
              <ion-select-option [value]="null">Nenhum</ion-select-option>
              <ion-select-option
                *ngFor="let ev of eventosDisponiveis"
                [value]="ev.id"
              >
                {{ ev.codigo }} - {{ ev.titulo }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-label>Sub-Eventos</ion-label>
            <ion-select
              formControlName="subEventosId"
              placeholder="Nenhum"
              multiple="true"
              interface="popover"
            >
              <ion-select-option
                *ngFor="let ev of eventosDisponiveis"
                [value]="ev.id"
              >
                {{ ev.codigo }} - {{ ev.titulo }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-label>Naturezas</ion-label>
            <ion-select
              formControlName="naturezasId"
              placeholder="Nenhuma"
              multiple="true"
              interface="popover"
            >
              <ion-select-option
                *ngFor="let n of naturezasDisponiveis"
                [value]="n.id"
              >
                {{ n.nome }} ({{ n.codigoNatureza }})
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-list>
      </ion-card>

      <ion-card *ngIf="isEditMode">
        <ion-card-header>
          <ion-card-title>Gerenciar Anexos</ion-card-title>
        </ion-card-header>
        <ion-list>
          <ion-item>
            <ion-label position="stacked"
              >Adicionar Anexos (Fotos, Documentos)</ion-label
            >
            <input
              type="file"
              hidden
              #fileUpload
              (change)="onFilesSelected($event)"
              multiple
              accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
            />
            <ion-button (click)="fileUpload.click()" slot="end" fill="outline">
              <ion-icon slot="start" name="attach-outline"></ion-icon>
              Selecionar
            </ion-button>
          </ion-item>

          <ion-list
            *ngIf="anexos.length > 0"
            lines="full"
            class="ion-no-padding"
          >
            <ion-list-header>
              <ion-label color="medium"
                ><small>Anexos (Máx. 5)</small></ion-label
              >
            </ion-list-header>
            <ng-container *ngFor="let anexo of anexos; let i = index">
              <ion-item *ngIf="!anexo.marcadoParaExcluir">
                <ion-icon
                  [name]="anexo.id ? 'link-outline' : 'document-text-outline'"
                  slot="start"
                  [color]="anexo.id ? 'primary' : 'medium'"
                ></ion-icon>
                <ion-input
                  [(ngModel)]="anexo.nomeOriginal"
                  [ngModelOptions]="{standalone: true}"
                  aria-label="Nome do anexo"
                ></ion-input>
                <ion-button
                  *ngIf="anexo.id"
                  fill="clear"
                  color="primary"
                  [href]="anexo.urlArmazenamento"
                  target="_blank"
                  slot="end"
                >
                  <ion-icon slot="icon-only" name="eye-outline"></ion-icon>
                </ion-button>
                <ion-button
                  fill="clear"
                  color="danger"
                  (click)="removerAnexo(anexo, i)"
                  slot="end"
                  size="small"
                >
                  <ion-icon
                    slot="icon-only"
                    name="trash-bin-outline"
                  ></ion-icon>
                </ion-button>
              </ion-item>
              <ion-item
                *ngIf="anexo.marcadoParaExcluir"
                lines="none"
                style="background: #fff5f5"
              >
                <ion-icon
                  name="trash-outline"
                  slot="start"
                  color="danger"
                ></ion-icon>
                <ion-label class="ion-text-wrap ion-text-small" color="danger">
                  <i style="text-decoration: line-through"
                    >{{ anexo.nomeOriginal }}</i
                  >
                </ion-label>
                <ion-button
                  fill="clear"
                  (click)="desfazerExclusaoAnexo(anexo)"
                  slot="end"
                >
                  <ion-icon
                    slot="icon-only"
                    name="arrow-undo-outline"
                  ></ion-icon>
                  Desfazer
                </ion-button>
              </ion-item>
            </ng-container>
          </ion-list>
        </ion-list>
      </ion-card>

      <div *ngIf="!isEditMode">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Sub-Eventos</ion-card-title>
          </ion-card-header>
          <ion-list>
            <ion-item
              *ngFor="let sub of evento.subEventos"
              [routerLink]="['/home/evento-detail', sub.id]"
            >
              <ion-label>
                <h2>{{ sub.codigo }} - {{ sub.titulo }}</h2>
                <p>Status: {{ sub.status }}</p>
              </ion-label>
            </ion-item>
            <ion-item
              *ngIf="!evento.subEventos || evento.subEventos.length === 0"
            >
              <ion-label>Nenhum sub-evento associado.</ion-label>
            </ion-item>
          </ion-list>
        </ion-card>

        <ion-card>
          <ion-card-header>
            <ion-card-title>Anexos</ion-card-title>
          </ion-card-header>
          <ion-list>
            <ion-item
              *ngFor="let anexo of evento.anexos"
              [href]="anexo.urlArmazenamento"
              target="_blank"
              rel="noopener noreferrer"
              button
              detail="true"
            >
              <ion-icon
                name="document-attach-outline"
                slot="start"
                color="medium"
              ></ion-icon>
              <ion-label>
                <h2>{{ anexo.nomeOriginal }}</h2>
                <p>{{ anexo.tipoConteudo }}</p>
              </ion-label>
              <ion-icon
                name="cloud-download-outline"
                slot="end"
                color="primary"
              ></ion-icon>
            </ion-item>
            <ion-item *ngIf="!evento.anexos || evento.anexos.length === 0">
              <ion-label>Nenhum anexo encontrado.</ion-label>
            </ion-item>
          </ion-list>
        </ion-card>
      </div>
    </form>
  </ion-content>

  <ion-footer *ngIf="isEditMode">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button color="danger" (click)="cancelEdit()">
          <ion-icon slot="start" name="close-circle-outline"></ion-icon>
          Cancelar
        </ion-button>
      </ion-buttons>
      <ion-buttons slot="primary">
        <ion-button (click)="onSubmit()" [disabled]="eventoForm.invalid">
          Salvar Alterações
          <ion-icon slot="end" name="save-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-footer>
</ng-container>

<ng-template #loading>
  <ion-header>
    <ion-toolbar color="primary">
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/home/evento-list"></ion-back-button>
      </ion-buttons>
      <ion-title>Carregando...</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content class="ion-padding ion-text-center">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Carregando detalhes do evento...</p>
  </ion-content>
</ng-template>
