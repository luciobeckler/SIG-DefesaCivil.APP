<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Gestão de Eventos</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-searchbar
      placeholder="Buscar por Código ou Título"
      [formControl]="searchTerm"
      debounce="300"
    >
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-grid>
    <ion-row>
      <ion-col size="12">
        <ion-item lines="none">
          <ion-label>Filtrar por Naturezas</ion-label>
          <ion-select
            placeholder="Todas"
            multiple="true"
            [formControl]="selectedNaturezas"
            interface="popover"
            class="ion-text-wrap"
          >
            <ion-select-option
              *ngFor="let nature of availableNatures"
              [value]="nature.id"
            >
              {{ nature.nome }} ({{ nature.codigoNatureza }})
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-col>
    </ion-row>
  </ion-grid>

  <div class="kanban-board-wrapper" *ngIf="!isLoading; else loading">
    <div class="kanban-board">
      <div class="kanban-column" *ngFor="let statusKey of statusOrder">
        <ion-toolbar class="kanban-column-header" color="light">
          <ion-title class="ion-text-center">
            {{ statusKey | formatStatus }} ({{ groupedEvents[statusKey]?.length
            || 0 }})
          </ion-title>
        </ion-toolbar>

        <div class="kanban-cards ion-padding-start ion-padding-end">
          <ng-container
            *ngIf="groupedEvents[statusKey] as eventsInColumn; else noEventsInColumn"
          >
            <ion-card
              *ngFor="let evento of eventsInColumn"
              [routerLink]="['/home/evento-detail', evento.id]"
              class="event-card"
              button="true"
            >
              <ion-card-header>
                <ion-card-subtitle>{{ evento.codigo }}</ion-card-subtitle>
                <ion-card-title>{{ evento.titulo }}</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <p><small>Resp: {{ evento.emailResponsavel }}</small></p>
                <div
                  *ngIf="evento.naturezas && evento.naturezas.length > 0"
                  class="nature-tags ion-padding-top"
                >
                  <ion-chip
                    *ngFor="let natureza of evento.naturezas"
                    outline="true"
                    color="primary"
                    class="ion-chip-small"
                  >
                    <ion-label>{{ natureza.nome }}</ion-label>
                  </ion-chip>
                </div>
              </ion-card-content>
            </ion-card>
          </ng-container>
          <ng-template #noEventsInColumn>
            <div class="ion-text-center ion-padding-top empty-column-message">
              <ion-text color="medium"><small>Nenhum evento</small></ion-text>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <ng-template #loading>
    <div class="ion-text-center ion-padding">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Carregando eventos...</p>
    </div>
  </ng-template>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button routerLink="/home/evento-form/new">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
