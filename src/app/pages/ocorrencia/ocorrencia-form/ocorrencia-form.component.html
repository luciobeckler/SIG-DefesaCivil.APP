<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="voltar()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>{{ tituloPagina }}</ion-title>

    <ion-buttons slot="end">
      <ng-container *appHasPermission="perms.OCORRENCIA_VISUALIZAR_HISTORICO">
        <ion-button
          *ngIf="isEditing"
          (click)="abrirHistorico()"
          title="Ver Histórico"
        >
          <ion-icon slot="icon-only" name="time-outline"></ion-icon>
        </ion-button>
      </ng-container>

      <ion-button (click)="salvar()" [strong]="true">Salvar</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="form">
    <ion-accordion-group [multiple]="true" [value]="['basicos', 'risco']">
      <ion-accordion value="basicos">
        <ion-item slot="header" color="light">
          <ion-icon
            name="information-circle-outline"
            slot="start"
            color="primary"
          ></ion-icon>
          <ion-label>Dados Básicos & Solicitante</ion-label>
        </ion-item>

        <div class="ion-padding" slot="content">
          <ion-list-header
            ><ion-label>Momento do Ocorrido *</ion-label></ion-list-header
          >
          <ion-row>
            <ion-col size="7">
              <ion-item>
                <ion-label position="stacked">Data</ion-label>
                <input
                  type="text"
                  formControlName="dataDoOcorrido"
                  placeholder="DD/MM/AAAA"
                  mask="d0/M0/0000"
                  [dropSpecialCharacters]="false"
                  class="custom-input-date"
                />
              </ion-item>
            </ion-col>
            <ion-col size="5">
              <ion-item>
                <ion-label position="stacked">Hora</ion-label>
                <input
                  type="text"
                  formControlName="horaDoOcorrido"
                  placeholder="HH:mm"
                  mask="Hh:m0"
                  [dropSpecialCharacters]="false"
                  class="custom-input-date"
                />
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-item
            lines="none"
            *ngIf="
              (form.get('dataDoOcorrido')?.invalid &&
                form.get('dataDoOcorrido')?.touched) ||
              (form.get('horaDoOcorrido')?.invalid &&
                form.get('horaDoOcorrido')?.touched)
            "
          >
            <ion-text color="danger" style="font-size: 0.8rem">
              Data e Hora são obrigatórias e devem ser válidas.
            </ion-text>
          </ion-item>

          <ion-list-header
            ><ion-label>Início do Atendimento</ion-label></ion-list-header
          >
          <ion-row>
            <ion-col size="7">
              <ion-item>
                <ion-label position="stacked">Data</ion-label>
                <input
                  type="text"
                  formControlName="dataInicioAtendimento"
                  placeholder="DD/MM/AAAA"
                  mask="d0/M0/0000"
                  [dropSpecialCharacters]="false"
                  class="custom-input-date"
                />
              </ion-item>
            </ion-col>
            <ion-col size="5">
              <ion-item>
                <ion-label position="stacked">Hora</ion-label>
                <input
                  type="text"
                  formControlName="horaInicioAtendimento"
                  placeholder="HH:mm"
                  mask="Hh:m0"
                  [dropSpecialCharacters]="false"
                  class="custom-input-date"
                />
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-list-header
            ><ion-label>Fim do Atendimento</ion-label></ion-list-header
          >
          <ion-row>
            <ion-col size="7">
              <ion-item>
                <ion-label position="stacked">Data</ion-label>
                <input
                  type="text"
                  formControlName="dataTerminoAtendimento"
                  placeholder="DD/MM/AAAA"
                  mask="d0/M0/0000"
                  [dropSpecialCharacters]="false"
                  class="custom-input-date"
                />
              </ion-item>
            </ion-col>
            <ion-col size="5">
              <ion-item>
                <ion-label position="stacked">Hora</ion-label>
                <input
                  type="text"
                  formControlName="horaTerminoAtendimento"
                  placeholder="HH:mm"
                  mask="Hh:m0"
                  [dropSpecialCharacters]="false"
                  class="custom-input-date"
                />
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-item>
            <ion-input
              label="Nome do Solicitante"
              labelPlacement="stacked"
              formControlName="solicitanteNome"
            ></ion-input>
          </ion-item>
          <ion-row>
            <ion-col>
              <ion-item>
                <ion-label position="stacked">CPF</ion-label>
                <input
                  type="text"
                  formControlName="solicitanteCPF"
                  placeholder="000.000.000-00"
                  mask="000.000.000-00"
                  [dropSpecialCharacters]="true"
                  class="custom-input-native"
                />
              </ion-item>
            </ion-col>
            <ion-col>
              <ion-item>
                <ion-input
                  label="RG"
                  labelPlacement="stacked"
                  formControlName="solicitanteRG"
                ></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>
        </div>
      </ion-accordion>

      <ion-accordion value="endereco">
        <ion-item slot="header" color="light">
          <ion-icon
            name="location-outline"
            slot="start"
            color="secondary"
          ></ion-icon>
          <ion-label>Endereço / Localização</ion-label>
        </ion-item>

        <div class="ion-padding" slot="content">
          <!-- <ion-row class="ion-margin-bottom">
            <ion-col size="6">
              <ion-button
                expand="block"
                color="secondary"
                (click)="capturarLocalizacaoAtual()"
              >
                <ion-icon name="locate-outline" slot="start"></ion-icon>
                Pegar GPS
              </ion-button>
            </ion-col>
          </ion-row> -->

          <ion-row *ngIf="form.get('latitude')?.value">
            <ion-col>
              <ion-note color="success">
                <ion-icon name="checkmark-circle"></ion-icon> Coordenadas
                salvas: {{ form.get("latitude")?.value | number: "1.4-4" }},
                {{ form.get("longitude")?.value | number: "1.4-4" }}
              </ion-note>
            </ion-col>
          </ion-row>

          <ion-item>
            <ion-label position="stacked">CEP</ion-label>
            <input
              type="text"
              formControlName="enderecoCEP"
              placeholder="00000-000"
              mask="00000-000"
              [dropSpecialCharacters]="true"
              (blur)="buscarCEP()"
              class="custom-input-native"
            />
          </ion-item>

          <ion-item>
            <ion-input
              label="Rua"
              labelPlacement="stacked"
              formControlName="enderecoRua"
            ></ion-input>
          </ion-item>

          <ion-row>
            <ion-col size="4">
              <ion-item>
                <ion-input
                  label="Número"
                  labelPlacement="stacked"
                  formControlName="enderecoNumero"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="8">
              <ion-item>
                <ion-input
                  label="Bairro"
                  labelPlacement="stacked"
                  formControlName="enderecoBairro"
                ></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-item>
            <ion-input
              label="Complemento"
              labelPlacement="stacked"
              formControlName="enderecoComplemento"
            ></ion-input>
          </ion-item>
        </div>
      </ion-accordion>

      <ion-accordion value="risco">
        <ion-item slot="header" color="light">
          <ion-icon
            name="warning-outline"
            slot="start"
            color="warning"
          ></ion-icon>
          <ion-label>Classificação de Risco</ion-label>
        </ion-item>
        <div class="ion-padding" slot="content">
          <ion-item>
            <ion-select
              label="Grau de Risco *"
              labelPlacement="stacked"
              formControlName="grauDeRisco"
              placeholder="Selecione"
            >
              @for (op of opcoesGrauRisco; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
          <ion-item
            lines="none"
            *ngIf="
              form.get('grauDeRisco')?.invalid &&
              form.get('grauDeRisco')?.touched
            "
          >
            <ion-text color="danger" style="font-size: 0.8rem">
              O Grau de Risco é obrigatório.
            </ion-text>
          </ion-item>

          <ion-item>
            <ion-select
              label="Tipo de Risco"
              labelPlacement="stacked"
              formControlName="tipoDeRisco"
              [multiple]="true"
            >
              @for (op of opcoesTipoRisco; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Análise Preliminar"
              labelPlacement="stacked"
              formControlName="analisePreliminar"
              [multiple]="true"
            >
              @for (op of opcoesAnalise; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Tipificação"
              labelPlacement="stacked"
              formControlName="tipificacaoDaOcorrencia"
              [multiple]="true"
            >
              @for (op of opcoesTipificacao; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Motivação"
              labelPlacement="stacked"
              formControlName="motivacao"
              [multiple]="true"
            >
              @for (op of opcoesMotivacao; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Área Afetada"
              labelPlacement="stacked"
              formControlName="areasAfetadas"
              [multiple]="true"
            >
              @for (op of opcoesAreaAfetada; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
        </div>
      </ion-accordion>

      <ion-accordion value="tecnico">
        <ion-item slot="header" color="light">
          <ion-icon
            name="construct-outline"
            slot="start"
            color="medium"
          ></ion-icon>
          <ion-label>Características Técnicas</ion-label>
        </ion-item>
        <div class="ion-padding" slot="content">
          <ion-item>
            <ion-select
              label="Regime de Ocupação"
              labelPlacement="stacked"
              formControlName="regimeDeOcupacaoDoImovel"
            >
              @for (op of opcoesRegime; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Caracterização Local"
              labelPlacement="stacked"
              formControlName="caracterizacaoDoLocal"
              [multiple]="true"
            >
              @for (op of opcoesCaracterizacao; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Tipo de Edificação"
              labelPlacement="stacked"
              formControlName="edificacao"
              [multiple]="true"
            >
              @for (op of opcoesEdificacao; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-select
              label="Estrutura"
              labelPlacement="stacked"
              formControlName="estrutura"
              [multiple]="true"
            >
              @for (op of opcoesEstrutura; track op) {
                <ion-select-option [value]="op">{{
                  formatarLabel(op)
                }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
        </div>
      </ion-accordion>

      <ion-accordion value="quantitativo">
        <ion-item slot="header" color="light">
          <ion-icon
            name="file-tray-full-outline"
            slot="start"
            color="tertiary"
          ></ion-icon>
          <ion-label>Dados Quantitativos</ion-label>
        </ion-item>
        <div class="ion-padding" slot="content">
          <ion-list-header
            ><ion-label>Estrutura Física</ion-label></ion-list-header
          >
          <ion-row>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="Nº Moradias"
                  labelPlacement="stacked"
                  formControlName="numeroDeMoradias"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="Nº Cômodos"
                  labelPlacement="stacked"
                  formControlName="numeroDeComodos"
                ></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="Nº Pavimentos"
                  labelPlacement="stacked"
                  formControlName="numeroDePavimentos"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item>
                <ion-select
                  label="Possui IPTU?"
                  labelPlacement="stacked"
                  formControlName="possuiIPTU"
                  placeholder="Selecione"
                >
                  <ion-select-option value="Sim">Sim</ion-select-option>
                  <ion-select-option value="Nao">Não</ion-select-option>
                  <ion-select-option value="Desconhecido"
                    >Desconhecido</ion-select-option
                  >
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-list-header
            ><ion-label>Pessoas Afetadas</ion-label></ion-list-header
          >
          <ion-row>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="Adultos"
                  labelPlacement="stacked"
                  formControlName="numeroDeAdultos"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="Crianças"
                  labelPlacement="stacked"
                  formControlName="numeroDeCriancas"
                ></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="Idosos"
                  labelPlacement="stacked"
                  formControlName="numeroDeIdosos"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item>
                <ion-input
                  type="number"
                  label="PCDs"
                  title="Pessoas com Deficiência"
                  labelPlacement="stacked"
                  formControlName="numeroDeDeficientes"
                ></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-item lines="none">
            <ion-checkbox formControlName="possuiUnidadeFamiliar">
              Possui Unidade Familiar?
            </ion-checkbox>
          </ion-item>
        </div>
      </ion-accordion>

      <ion-accordion value="anexos">
        <ion-item slot="header" color="light">
          <ion-icon name="document-attach" slot="start"></ion-icon>
          <ion-label>Anexos & Fotos</ion-label>
          <ion-badge slot="end" color="secondary">
            {{ anexosExistentes.length + novosAnexos.length }}
          </ion-badge>
        </ion-item>

        <div class="ion-padding" slot="content">
          <input
            type="file"
            #fileInput
            multiple
            (change)="onFileSelected($event)"
            style="display: none"
          />
          <ion-row class="ion-margin-bottom">
            <ion-col size="6">
              <ion-button
                expand="block"
                fill="outline"
                (click)="fileInput.click()"
              >
                <ion-icon name="folder-open" slot="start"></ion-icon> Galeria
              </ion-button>
            </ion-col>
            <ion-col size="6">
              <ion-button expand="block" color="primary" (click)="tirarFoto()">
                <ion-icon name="camera" slot="start"></ion-icon> Câmera
              </ion-button>
            </ion-col>
          </ion-row>

          <ion-list-header *ngIf="novosAnexos.length > 0">
            <ion-label>Novos (Ainda não salvos)</ion-label>
          </ion-list-header>

          <ion-list>
            <ion-item *ngFor="let item of novosAnexos; let i = index">
              <ion-icon
                slot="start"
                name="document-text-outline"
                size="large"
                color="medium"
              ></ion-icon>

              <ion-input
                label="Nome do Arquivo"
                labelPlacement="stacked"
                [(ngModel)]="item.nome"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Nome do arquivo"
              ></ion-input>

              <div
                slot="end"
                style="
                  display: flex;
                  flex-direction: column;
                  align-items: flex-end;
                "
              >
                <ion-note class="ion-hide-sm-down">{{ item.tamanho }}</ion-note>
                <ion-badge color="success" *ngIf="item.latitudeCaptura"
                  >Com GPS</ion-badge
                >
              </div>

              <ion-button
                fill="clear"
                color="danger"
                slot="end"
                (click)="removerNovoAnexo(i)"
              >
                <ion-icon slot="icon-only" name="trash"></ion-icon>
              </ion-button>
            </ion-item>

            <ion-list-header *ngIf="anexosExistentes.length > 0">
              <ion-label>Arquivos Salvos</ion-label>
            </ion-list-header>

            <ion-item *ngFor="let anexo of anexosExistentes">
              <ion-label class="ion-text-wrap">
                <h2>{{ anexo.nomeOriginal }}</h2>

                <div style="margin-top: 8px; font-size: 0.85rem; color: #666">
                  <p style="margin: 0; display: flex; align-items: center">
                    <ion-icon
                      name="time-outline"
                      style="margin-right: 4px"
                    ></ion-icon>
                    Captura:
                    <strong
                      *ngIf="anexo.dataHoraCaptura"
                      style="margin-left: 4px; color: #3880ff"
                    >
                      {{ anexo.dataHoraCaptura | date: "dd/MM/yyyy HH:mm" }}
                    </strong>
                    <span
                      *ngIf="!anexo.dataHoraCaptura"
                      style="margin-left: 4px; font-style: italic"
                    >
                      Não registrada
                    </span>
                  </p>

                  <p
                    style="
                      margin: 2px 0 0 0;
                      display: flex;
                      align-items: center;
                    "
                  >
                    <ion-icon
                      name="location-outline"
                      style="margin-right: 4px"
                    ></ion-icon>
                    GPS:
                    <strong
                      *ngIf="
                        anexo.latitudeCaptura !== null &&
                        anexo.longitudeCaptura !== null
                      "
                      class="ion-selectable"
                      style="margin-left: 4px; color: #2dd36f"
                    >
                      {{ anexo.latitudeCaptura }}, {{ anexo.longitudeCaptura }}
                    </strong>
                    <span
                      *ngIf="
                        anexo.latitudeCaptura === null ||
                        anexo.longitudeCaptura === null
                      "
                      style="margin-left: 4px; font-style: italic"
                    >
                      Indisponível
                    </span>
                  </p>
                </div>
              </ion-label>

              <div
                slot="end"
                style="display: flex; gap: 8px; align-items: center"
              >
                <ion-button
                  fill="outline"
                  color="primary"
                  [href]="anexo.urlArmazenamento"
                  target="_blank"
                  title="Visualizar Anexo"
                >
                  <ion-icon slot="icon-only" name="eye-outline"></ion-icon>
                </ion-button>

                <ion-button
                  fill="clear"
                  color="danger"
                  (click)="marcarParaRemocao(anexo)"
                  title="Excluir Anexo"
                >
                  <ion-icon slot="icon-only" name="trash"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-list>

          <div
            *ngIf="anexosExistentes.length === 0 && novosAnexos.length === 0"
            class="ion-text-center ion-padding"
          >
            <ion-text color="medium">Nenhum anexo vinculado.</ion-text>
          </div>
        </div>
      </ion-accordion>
    </ion-accordion-group>
  </form>
</ion-content>
