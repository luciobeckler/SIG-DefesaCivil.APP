<ion-content class="ion-padding">
  <ion-button
    class="add-user-button"
    expand="block"
    color="primary"
    (click)="abrirModalUsuario()"
  >
    <ion-icon name="person-add" slot="start"></ion-icon>
    Adicionar Usuário
  </ion-button>

  <ion-card>
    <ion-grid>
      <ion-row class="header-row bordered-row">
        <ion-col class="bordered-col"><strong>Nome</strong></ion-col>
        <ion-col class="bordered-col"><strong>Cargo</strong></ion-col>
        <ion-col class="bordered-col"><strong>Permissões</strong></ion-col>
        <ion-col class="bordered-col"><strong>Ações</strong></ion-col>
      </ion-row>

      @for (user of usuarios; track user.id) {
        <ion-row class="bordered-row">
          <ion-col class="bordered-col">{{ user.nome }}</ion-col>
          <ion-col class="bordered-col">{{ user.cargo }}</ion-col>
          <ion-col class="bordered-col">{{ user.permissao }}</ion-col>
          <ion-col class="bordered-col">
            <ion-button
              size="small"
              color="tertiary"
              fill="clear"
              (click)="abrirModalUsuario(user)"
            >
              <ion-icon name="pencil" slot="icon-only"></ion-icon>
            </ion-button>

            <ion-button
              size="small"
              color="danger"
              fill="clear"
              (click)="confirmarExclusao(user)"
            >
              <ion-icon name="trash" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      }
    </ion-grid>
  </ion-card>
</ion-content>

<ion-modal [isOpen]="mostrarModal" (didDismiss)="fecharModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>{{
          isCreaterOrEdit ? "Registrar Novo Usuário" : "Editar usuário"
        }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="fecharModal()">Fechar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-item>
      <ion-text> Campos com * são obrigatórios </ion-text>
    </ion-item>

    <ion-content class="ion-padding">
      <form #userForm="ngForm">
        <ion-item>
          <ion-label
            position="stacked"
            [class.label-invalid]="nome.invalid && nome.touched"
            >Nome*</ion-label
          >
          <input
            class="native-input"
            [(ngModel)]="usuarioSelecionado.nome"
            name="nome"
            required
            #nome="ngModel"
          />
        </ion-item>
        <ion-item>
          <ion-label
            position="stacked"
            [class.label-invalid]="email.invalid && email.touched"
            >Email*</ion-label
          >
          <input
            class="native-input"
            type="email"
            [(ngModel)]="usuarioSelecionado.email"
            name="email"
            required
            email
            #email="ngModel"
          />
        </ion-item>

        <ion-item>
          <ion-label
            position="stacked"
            [class.label-invalid]="telefone.invalid && telefone.touched"
            >Telefone*</ion-label
          >
          <input
            type="text"
            mask="(00) 00000-0000"
            class="native-input"
            [(ngModel)]="usuarioSelecionado.telefone"
            name="telefone"
            required
            #telefone="ngModel"
          />
        </ion-item>
        @if (
          telefone.valid &&
          telefone.touched &&
          !validarTelefone(usuarioSelecionado.telefone)
        ) {
          <ion-text color="danger"
            >Telefone inválido. Informe DDD + número.</ion-text
          >
        }

        <ion-item>
          <ion-label
            position="stacked"
            [class.label-invalid]="cpf.invalid && cpf.touched"
            >CPF*</ion-label
          >
          <input
            [(ngModel)]="usuarioSelecionado.cpf"
            class="native-input"
            name="cpf"
            mask="000.000.000-00"
            required
            #cpf="ngModel"
          />
        </ion-item>
        @if (cpf.invalid && cpf.touched) {
          @if (cpf.errors?.["minlength"] || cpf.errors?.["maxlength"]) {
            <ion-text color="danger">CPF deve ter 11 dígitos.</ion-text>
          }
        }
        @if (cpf.valid && cpf.touched && !validarCPF(usuarioSelecionado.cpf)) {
          <ion-text color="danger">CPF inválido.</ion-text>
        }

        <ion-item>
          <ion-label
            position="stacked"
            [class.label-invalid]="cargo.invalid && cargo.touched"
            >Cargo*</ion-label
          >
          <ion-input
            [(ngModel)]="usuarioSelecionado.cargo"
            name="cargo"
            required
            #cargo="ngModel"
          ></ion-input>
        </ion-item>
        <ion-item>
          <ion-label
            position="stacked"
            [class.label-invalid]="permissao.invalid && permissao.touched"
            >Permissão*</ion-label
          >
          <ion-select
            [(ngModel)]="usuarioSelecionado.permissao"
            name="permissao"
            required
            #permissao="ngModel"
            interface="popover"
          >
            <ion-select-option value="AgenteDeCampo"
              >Agente de campo</ion-select-option
            >
            <ion-select-option value="Diretor">Diretor</ion-select-option>
            <ion-select-option value="Administrador"
              >Administrador</ion-select-option
            >
          </ion-select>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Data de Nascimento</ion-label>
          <input
            class="native-input"
            placeholder="DD/MM/AAAA"
            [(ngModel)]="dataNascimentoString"
            name="dataDeNascimentoInput"
            #dataNascimentoInput="ngModel"
            mask="00/00/0000"
          />
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Data de Admissão</ion-label>
          <input
            class="native-input"
            placeholder="DD/MM/AAAA"
            [(ngModel)]="dataAdmissaoString"
            name="dataAdmissaoInput"
            #dataAdmissaoInput="ngModel"
            mask="00/00/0000"
          />
        </ion-item>

        <ion-item>
          <ion-label [class.label-invalid]="isAtivo.invalid && isAtivo.touched"
            >Está ativo?*</ion-label
          >
          <ion-toggle
            [(ngModel)]="usuarioSelecionado.isAtivo"
            name="isAtivo"
            required
            #isAtivo="ngModel"
          ></ion-toggle>
        </ion-item>
        <ion-button
          expand="full"
          color="success"
          (click)="onSaveModal()"
          [disabled]="userForm.invalid"
          >Salvar</ion-button
        >
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
